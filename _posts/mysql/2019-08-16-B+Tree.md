---
layout: second_template
title: B+Tree
category: mysql
tagline: "Supporting tagline"
tags : [mysql]
permalink: B+Tree
---
[page-structure]:/innoDB-page-structure
[page-record]:assets/themes/my_blog/img/page-record.jpg
[page_page]:assets/themes/my_blog/img/page_page.jpg
[BTree_InnoDB]:assets/themes/my_blog/img/BTree_InnoDB.jpg

***
* ### B+Tree在InnoDB中的应用 ###

	上一篇[文章][page-structure]分析了数据页结构，**通过文件头部信息也只知道数据页之间是通过双向链表的形式组织起来的，而数据页内的记录是按照主键大小通过单向链表的形式组织起来的**。看起来像这样：


	![Alt text][page-record]


	![Alt text][page_page]

	先抛出一个问题：**假如我们想查找主键为X值的记录，怎么查找？ 在哪个数据页上？** 只要我们知道哪个数据页就好办了，找到对应数据页在页目录上通过二分查找就知道在哪个槽slot上，然后通过遍历找到对应的记录。

	在哪个数据页上？虽然数据页之间通过双向链表的形式组织起来，但是我们不能通过遍历的方式查找，对于庞大的数据效率很低。**InnoDB的做法是将每个页的最小主键值和页号提取出来，放入另外一个数据页，做法类似数据页内的页目录，我们可以称为目录项数据页，目录项数据页里存储的记录record_type=1；当目录项数据页超过16k，则再申请一个目录项数据页，同样目录项数据页之间以双向链表形式组织起来，当目录项数据页很多时那么再从目录项数据页提取最小主键值和页号，放入另外一个数据页**。看起来像这样：

	![Alt text][BTree_InnoDB]

	目录项数据页里的记录与用户数据页里的记录有这几点区别：

	* 目录项记录的record_type值是1，而普通用户记录的record_type值是0
	* 目录项记录只有主键值和页的编号两个列，而普通的用户记录的列是用户自己定义的，可能包含很多列，另外还有InnoDB自己添加的隐藏列
	* 记录头信息里的min_rec_mask的属性只有在存储目录项记录的页中的主键值最小的目录项记录的min_rec_mask值为1，其他别的记录的min_rec_mask值都是0

	存放目录项的数据页与存放用户数据的数据页没什么区别，数据页结构也一样，数据页里面都有页目录，同样可以使用二分查找法进行查找。现在根据主键查找用户数据可以分为以下步骤，例如根据上图的B+Tree查找主键值为2的用户数据：

	1. 从根节点（最上层数据页）通过二分查找确定主键值为2的数据页编号是4

	2. 到编号为4的数据页查找主键值为2的数据页，同样二分查找确定存放主键值为2的用户数据在编号为7的数据页

	3. 同样到编号为7的数据页查找用户数据，具体方法不再说明

	以上图3层B+Tree为例计算一下我们能够存放多少数据，当叶子结点可以存放100条用户数据，非叶子结点可以存放1000条目录项数据，那么整颗树可以存放1000 X 1000 X 100=100000000，那么4层会更多。同时查找很快，只能说设计很精妙





